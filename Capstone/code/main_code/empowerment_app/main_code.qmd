---
title: "main_code"
format: html
editor: visual
---

<!-- installing libraries -->

```{r, message=FALSE, warning=FALSE}
library(readr)
library(dplyr)
library(tidyr)
library(ggplot2)
library(maps)
library(plotly)
library(tidyverse)
library(gganimate)
library(vdemdata)
library(countrycode)
```

<!-- loading dataset -->

```{r, message=FALSE}
vdemfull <- vdemdata::vdem
onlycountries <- vdemfull[-c(25990:27555), ]

map <- map_data("world")
map$region[map$region == "USA"] = "United States of America"
map$region[map$region == "UK"] = "United Kingdom"
map$region[map$region == "Czech Republic"] = "Czechia"
map$region[map$region == "Myanmar"] = "Burma/Myanmar"
map$region[map$region == "Republic of Congo"] = "Republic of the Congo"

```

<!-- womens empowerment variables -->

```{r}
allwemp <- onlycountries %>% select(region = country_name, abbr = country_text_id, id = country_id, year = year, wpei = v2x_gender, liberties = v2x_gencl, society = v2x_gencs, participation = v2x_genpp)
wemp100yr <- filter(allwemp, year >= 1900, year <= 2000)
mapwemp100yr <- left_join(wemp100yr, map, by = "region")
```

<!-- voting rights -->

```{r}
allvoting <- onlycountries %>% select(region = country_name, abbr = country_text_id, id = country_id, year = year, voting = v2fsuffrage)
voting100yr <- filter(allvoting, year >1899, year <2001)
```

<!-- category breakup -->

```{r}
quantiles <- quantile(wemp100yr$wpei, probs = c(1/4, 2/4, 3/4), na.rm = TRUE)
quantiles
wemp100yr[, 'category'] = NA 
wemp100yr[, 'categoryvalue'] = NA
# categories nascent: wpei<0.188; emerging: 0.188<wpei<0.336; developing: 0.336<wpei<0.546    established: wpei>.546
wemp100yr$category <- as.factor(ifelse(wemp100yr$wpei<=0.188, 'nascent',
                                  ifelse(wemp100yr$wpei>=0.188 & wemp100yr$wpei<=0.336, 'emerging',
                                    ifelse(wemp100yr$wpei>=0.336 & wemp100yr$wpei<=0.546, 'developing',
                                    ifelse(wemp100yr$wpei>=0.546, 'established', 'none')))))
wemp100yr$categoryvalue <- as.numeric(ifelse(wemp100yr$wpei<=0.188, 1,
                                    ifelse(wemp100yr$wpei>=0.188 & wemp100yr$wpei<=0.336, 2,
                                    ifelse(wemp100yr$wpei>=0.336 & wemp100yr$wpei<=0.546, 3,
                                    ifelse(wemp100yr$wpei>=0.546, 4, 0)))))
summary(wemp100yr)
```
<!-- Correlation between indicators and categories --->
```{r}
wemp100yr <- wemp100yr %>%
  mutate(wpei_category = case_when(
    wpei < 0.188 ~ 'nascent',
    wpei >= 0.188 & wpei <= 0.336 ~ 'emerging',
    wpei > 0.336 & wpei <= 0.546 ~ 'developing',
    wpei > 0.546 ~ 'established'
  )) %>%
  filter(!is.na(wpei_category))

category_correlations <- wemp100yr %>%
  group_by(wpei_category) %>%
  summarise(
    society_liberties_corr = ifelse(n() > 1, cor(society, liberties, use = "complete.obs"), NA),
    society_participation_corr = ifelse(n() > 1, cor(society, participation, use = "complete.obs"), NA),
    liberties_participation_corr = ifelse(n() > 1, cor(liberties, participation, use = "complete.obs"), NA)
  ) %>%
  ungroup()
print(category_correlations)
```

<!-- finding transition periods -->

```{r message=FALSE, warning=FALSE}
#grouping for analysis
grouped_wemp <- wemp100yr %>%
  group_by(year, category) %>%
  summarise(count = n(), .groups = 'drop')
grouped_wemp <- drop_na(grouped_wemp)
#visualizations to determine transitions
grouppoint <- ggplot(grouped_wemp) + geom_point(aes(x = year, y = count, color = category)) 
groupbar <- ggplot(grouped_wemp, aes(x = year, y = count, fill = category)) + geom_bar(stat='identity', position=position_dodge()) + facet_wrap(.~category) + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
groupbar <- ggplotly(groupbar)
groupbar
grouppoint <- ggplotly(grouppoint)
# Summarize by category and year
category_summary <- wemp100yr %>%
  group_by(category, year) %>%
  summarise(categoryvalue = sum(categoryvalue), .groups = 'drop')

# Find the max category value for each category
max_years <- category_summary %>%
  group_by(category) %>%
  summarise(max_value = max(categoryvalue), .groups = 'drop')

# Define thresholds
thresholds <- c(0.9, 0.8, 0.75)

# Function to calculate main years range for each threshold
calculate_main_years_range <- function(threshold) {
  category_summary %>%
    inner_join(max_years, by = "category") %>%
    group_by(category) %>%
    filter(categoryvalue >= max_value * threshold) %>%
    summarise(StartYear = min(year), EndYear = max(year), .groups = 'drop')
}

# Apply function for each threshold
results <- lapply(thresholds, calculate_main_years_range)
print(results)
```

<!-- adding transition periods to dataset-->

```{r}
#periods: nascent 1900 - 1955   developing - 1956 - 1978     established 1979 - 2000
periods <- filter(allwemp, year >= 1900, year <= 2000)
periods[, 'category'] = NA 
periods[, 'categoryvalue'] = NA

periods$category <- as.factor(ifelse(periods$year>=1900 & periods$year<=1955, 'nascent',
                                  ifelse(periods$year>=1956 & periods$year<=1978, 'developing',
                                    ifelse(periods$year>=1979, 'established', 'none'))))
periods$categoryvalue <- as.numeric(ifelse(periods$year>=1900 & periods$year<=1955, 1,
                                  ifelse(periods$year>=1956 & periods$year<=1978, 2,
                                    ifelse(periods$year>=1979, 3, 0))))
```

<!-- filtering data to compare voting rights and transition periods -->

```{r, warning=FALSE, message=FALSE}
combined <- merge(voting100yr, wemp100yr, by = c("id", "year", "abbr", "region"), all.x = TRUE)
combined <-  combined %>%
    replace_na(list(voting = 0, category = "nascent", categoryvalue = 0))
combined$voting <- as.numeric((as.character(combined$voting)))
combined$voting <- ifelse(combined$voting > 0, 1, 0)
combined <- combined %>%
  mutate(change_point = ifelse(voting == 1, "Change", "No Change"))
combined <- combined %>%
  mutate(continent = countrycode(as.character(abbr), "wb", "continent"))
votechange <- combined %>%
    arrange(region, year) %>%
    group_by(region) %>%
    mutate(change = voting != lag(voting, default = first(voting))) %>%
    filter(change)
all <- unique(voting100yr$region)
change <- unique(votechange$region)
missing <- setdiff(all, change)
votechange <- select(votechange, -change)
missingblank <- data.frame(region = missing,
                      year = NA,
                      voting = NA,
                      category = NA,
                      categoryvalue = NA)
missinginfo <- combined %>%
    filter(region %in% missing) %>%
    group_by(region) %>%
    summarise(year=min(year), abbr = first(abbr), id = first(id), voting = first(voting), category = first(category), categoryvalue = first(categoryvalue), .groups = 'drop') %>%
    mutate(change_point = "No Change")
analysis <- bind_rows(votechange, missinginfo)
analysis$continent <- countrycode(analysis$abbr, "wb", "continent")

groupedanalysis <- analysis %>%
  group_by(region, change_point) %>%
  summarise(count = n(), .groups = 'drop')
groupedanalysis <- drop_na(groupedanalysis)
changesgrouped <- filter(groupedanalysis, change_point =="Change")
#checking all countries present
# original_countries <- unique(voting100yr$region)
# full_dataset_countries <- unique(combined$region)
# all_countries_present <- all(original_countries %in% full_dataset_countries)
#print(all_countries_present)
combined_map <- left_join(combined, map, by = "region")
analysis_map <- left_join(analysis, map, by = "region")
```

<!-- continent breakdown -->

```{r}
Americas <- filter(analysis_map, continent == "Americas")
Europe <- filter(analysis_map, continent == "Europe")
Asia <- filter(analysis_map, continent == "Asia")
Africa <- filter(analysis_map, continent == "Africa")
Oceania <- filter(analysis_map, continent == "Oceania")

```

<!-- WPEI Average graphs -->

```{r}
# #finding averages
# avg_wpei_region <- wemp100yr %>%
#     group_by(region) %>%
#     summarise(avg_wpei = mean(wpei, na.rm = TRUE))
# summary(avg_wpei_region)
# avg_wpei_year <- wemp100yr %>%
#     group_by(year) %>%
#     summarise(avg_wpei = mean(wpei, na.rm = TRUE))
# summary(avg_wpei_year)
# 
# #top ten years table
# top_ten_years <- avg_wpei_year %>%
#   arrange(desc(avg_wpei)) %>%
#   slice_head(n = 10)
# top_ten_years$year <- factor(top_ten_years$year, levels = top_ten_years$year)
# head(top_ten_years)
# #top ten countries table
# top_ten_region <- avg_wpei_region %>%
#   arrange(desc(avg_wpei)) %>%
#   slice_head(n = 10)
# head(top_ten_region)
```
<!-- Voting and WPEI Decade Analysis -->
```{r}
combined$year <- as.integer(combined$year)
combined$decade <- floor(combined$year / 10) * 10

#VOTE
first_voting_instances <- combined %>%
  dplyr::filter(voting == 1) %>%
  group_by(region) %>%
  summarize(first_vote_year = min(year)) %>%
  ungroup()
first_voting_instances$decade <- floor(first_voting_instances$first_vote_year / 10) * 10
votes_by_decade <- first_voting_instances %>%
  dplyr::count(decade)
print(votes_by_decade)
#GRAPH
ggplot(votes_by_decade, aes(x = as.factor(decade), y = n)) +
  geom_bar(stat = "identity", fill = "#806E88") +
  coord_flip() +
  theme_minimal(base_size = 14) +
  theme(
    legend.position = "none",
    axis.text.x = element_text(angle = 45, hjust = 1),
    axis.title.x = element_text(size = 16, margin = margin(t = 20)),
    axis.title.y = element_text(size = 16, margin = margin(r = 20))
  ) +
  labs(title = "First Instances of Women's Suffrage by Decade",
       x = "Decade",
       y = "Countries") +
  scale_x_discrete(labels = function(x) paste0(x, "s"))
#LEVELS
grouped_combined <- combined %>%
  group_by(decade, category) %>%
  summarise(count = n_distinct(region), .groups = 'drop')
#GRAPH
colorgraph <- ggplot(grouped_combined, aes(x = as.factor(decade), y = count, fill = category)) +
  geom_bar(stat = "identity", position = "stack") +
  coord_flip() +
  theme_minimal(base_size = 14) +
  theme(
    legend.position = "bottom",
    legend.text = element_text(size = 12),
    legend.title = element_text(size = 14),
    axis.text.x = element_text(angle = 45, hjust = 1),
    axis.title.x = element_text(size = 16, margin = margin(t = 20)),
    axis.title.y = element_text(size = 16, margin = margin(r = 20))
  ) +
  scale_fill_manual(values = c(
    "nascent" = "#f2ab9b", 
    "developing" = "#3b5e8c", 
    "emerging" = "#f2b872", 
    "established" = "#957DAD"
  )) +
  labs(title = "Empowerment Variables by Decade",
       x = "Decade",
       y = "Number of Countries") +
  scale_x_discrete(labels = function(x) paste0(x, "s")) +
  facet_wrap(~category)
intercolor <- ggplotly(colorgraph)
intercolor
```

<!-- maps -->

```{r}
allworld <- ggplot() +
  geom_polygon(data = combined_map %>% filter(year == 1930), 
               aes(x = long, y = lat, group = group, fill = category)) +
  geom_polygon(data = combined_map %>% filter(year == 1930, voting == 1), 
               aes(x = long, y = lat, group = group, color = "Voting Rights"), 
               fill = NA, size = 0.25) +
  geom_polygon(data = combined_map %>% filter(year == 1930, voting == 0), 
               aes(x = long, y = lat, group = group, color = "No Voting Rights"), 
               fill = NA, size = 0.25, linetype = "dashed") +
  scale_color_manual(name = "Voting Rights",
                     values = c("Voting Rights" = "black", "No Voting Rights" = "red"),
                     labels = c("Voting Rights", "No Voting Rights"),
                     guide = guide_legend(override.aes = list(linetype = c("solid", "dashed"), size = 1))) +
  theme_classic() +
  labs(title = "Empowerment Category and Voting Rights in 1930", fill = "Category") +
  guides(fill = guide_legend(title = "Category"),
         color = guide_legend(title = "Voting Rights Status"))
allworld

allcontinents <- ggplot() +
  geom_polygon(data = combined_map %>% filter(year == 1930, continent == "Europe"), 
               aes(x = long, y = lat, group = group, fill = category)) +
  geom_polygon(data = combined_map %>% filter(year == 1930, continent == "Europe", voting == 1), 
               aes(x = long, y = lat, group = group, color = "Voting Rights"), 
               fill = NA, size = 0.25) +
  geom_polygon(data = combined_map %>% filter(year == 1930, voting == 0, continent == "Europe"), 
               aes(x = long, y = lat, group = group, color = "No Voting Rights"), 
               fill = NA, size = 0.25, linetype = "dashed") +
  scale_color_manual(name = "Voting Rights",
                     values = c("Voting Rights" = "black", "No Voting Rights" = "red"),
                     labels = c("Voting Rights", "No Voting Rights"),
                     guide = guide_legend(override.aes = list(linetype = c("solid", "dashed"), size = 1))) +
  theme_classic() +
  labs(title = "Empowerment Category and Voting Rights in 1930", fill = "Category") +
  guides(fill = guide_legend(title = "Category"),
         color = guide_legend(title = "Voting Rights Status"))
allcontinents
categoriescontinents <- ggplot(data = combined_map %>% filter(continent == "Africa") %>% filter(year == 1996), aes (x = long, y = lat, group = group, fill = category)) + geom_polygon() + theme_classic() +labs(title = "Empowerment Category", fill="category")
categoriescontinents
votingcontinents <- ggplot(data = combined_map %>% filter(continent == "Africa") %>% filter(year == 1996), aes (x = long, y = lat, group = group, fill = voting)) + geom_polygon() + theme_classic() +labs(title = "Empowerment Category", fill="vote")
votingcontinents
categoriesworld <- ggplot(data = combined_map %>% filter(year == 2000), aes (x = long, y = lat, group = group, fill = category)) + geom_polygon() + theme_classic() +labs(title = "Empowerment Category", fill="category")
categoriesworld

categoriescontinents <- ggplot(data = combined_map %>% filter(continent == "Africa") %>% filter(year == 1996), aes (x = long, y = lat, group = group, fill = category)) + geom_polygon() + theme_classic() +labs(title = "Empowerment Category", fill="category")
categoriescontinents

votingworld <- ggplot(data = combined_map %>% filter(year == 1905), aes(x = long, y = lat, group = group, fill = factor(voting))) + 
  geom_polygon() + 
  theme_classic() +
  labs(title = "Voting in 1996", fill="Voting Status") +
  scale_fill_manual(values = c("0" = "black", "1" = "#806E88"),
                    labels = c("0" = "No Voting", "1" = "Voting")) +
  theme(legend.position = "right")
votingworld

empowermentcountry <- ggplot(data = combined_map %>% filter(year == 1912, region == "France"), aes(x = long, y = lat, group = group, fill = category)) +
  geom_polygon() + 
  geom_polygon(data = combined_map %>% filter(year == 1912, region == "France", voting == 1), aes(color = "Yes"), fill = NA, size = 0.25, linetype = "dashed") +
  geom_polygon(data = combined_map %>% filter(year == 1912, region == "France", voting == 0), aes(color = "No"), fill = NA, size = 0.25) +
  scale_fill_manual(values = c("nascent" = "#f2ab9b", "developing" = "#3b5e8c", "emerging" = "#f2b872", "established" = "#957DAD")) +
  scale_color_manual(values = c("Yes" = "black", "No" = "red")) +
  theme_void() +
  labs(title = "Empowerment Category in France, 1990", fill = "Category")
empowermentcountry

```
<!-- animated wpei gif -->

```{r}
library(ggplot2)
library(maps)
library(dplyr)
library(animation)

years_data <- list(
  wemp1900 = filter(mapwemp100yr, year == 1900),
  wemp1925 = filter(mapwemp100yr, year == 1925),
  wemp1950 = filter(mapwemp100yr, year == 1950),
  wemp1975 = filter(mapwemp100yr, year == 1975),
  wemp2000 = filter(mapwemp100yr, year == 2000)
)
map_data <- map_data("world")
basemap <- ggplot() + 
  geom_polygon(data = map_data, aes(x = long, y = lat, group = group), fill = "gray", color = "white")
plot_map_for_year <- function(year_data) {
  basemap +
    geom_polygon(data = year_data, aes(x = long, y = lat, fill = wpei, group = group), color = "white") +
    scale_fill_gradient(low = "#FFCC99", high = "#CC6600", name = "WPEI") +
    labs(title = paste("Year:", unique(year_data$year))) +
    theme_void()
}
liberties_map <- function(year_data) {
  basemap +
    geom_polygon(data = year_data, aes(x = long, y = lat, fill = liberties, group = group), color = "white") +
    scale_fill_gradient(low = "#90EE90", high = "#006400", name = "WCLI") +
    labs(title = paste("Year:", unique(year_data$year))) +
    theme_void()
}
society_map <- function(year_data) {
  basemap +
    geom_polygon(data = year_data, aes(x = long, y = lat, fill = society, group = group), color = "white") +
    scale_fill_gradient(low = "#D8BFD8", high = "#4B0082", name = "WCSPI") +
    labs(title = paste("Year:", unique(year_data$year))) +
    theme_void()
}
participation_map <- function(year_data) {
  basemap +
    geom_polygon(data = year_data, aes(x = long, y = lat, fill = society, group = group), color = "white") +
    scale_fill_gradient(low = "#ADD8E6", high = "#00008B", name = "WPPI") +
    labs(title = paste("Year:", unique(year_data$year))) +
    theme_void()
}


saveGIF({
  for(year_data in years_data) {
    print(participation_map(year_data))
  }
}, movie.name = "participation_animation.gif", interval = 2, ani.width = 800, ani.height = 600)

```

<!-- animated empowerment levels gif -->
<!-- creating a csv file of cleaned data -->

```{r}
# write_csv(wemp100yr, 'wemp100yr.csv')
# write_csv(voting100yr, 'voting100yr.csv')
# write_csv(analysis_map, 'analysis_map.csv')
# write_csv(combined_map, 'combined_map.csv')
#write_csv(combined, 'combined.csv')
```

